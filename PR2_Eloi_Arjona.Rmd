---
title: "PR2_ Compra_venta_coches"
author: "Eloi"
date: "2025-12-28"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load packages

```{r packages}
library("ggplot2")
library("fitdistrplus")
library("MASS")
library("survival")
library("ggstatsplot")
library("tidyverse")
```

## Càrrega arxius i dimensions (N x M)

```{r load data}
x=read.csv("autos_espana.csv", stringsAsFactors = T)
dim(x)
```

## Neteja de dades

Primer veurem la estructura del datatest

```{r summary, echo=TRUE}
summary(x)
```

Per respondre a les preguntes realitzades al document entregat a PR1 ens centrarem en netejar les següents columnes:

Price, KM,	CV,	Weight, Oto100, Sticker,Location, Brand, Fuel, Transmission	

A part de les variables que crearé, posteriorment:


```{r summary_utiltitat, echo=TRUE}
# 1. Definim la llista de variables que farem servir per a les 5 preguntes
variables_utilitat <- c("Price", "KM", "CV", "Weight", "Year", 
                        "Sticker", "Location", "Brand", "Fuel", "X0to100")

# 2. Mostrem el sumari només d'aquestes columnes
summary(x[, variables_utilitat])
```     

### Location

Comp podem veure te 1139 fila buides per tant les eliminem:

```{r location, echo=TRUE}
# 1. Filtrem per eliminar els buits i els NAs a Location
x_neta <- x %>%
  filter(Location != "" & !is.na(Location))

# 2. (Opcional) Eliminar el nivell buit del factor
# Com que vas carregar amb stringsAsFactors = T, el nivell "" encara existirà
x_neta$Location <- droplevels(x_neta$Location)

# 3. Comprovem quantes files han quedat
dim(x_neta)
summary(x_neta$Location)
```   
Com podem veure hi ha 49 casos amb "La" és comú amb molts datatesr Espanyols que la es refereixi a "La CORUÑA" per tant tornarem faré aquest canvi, També tenim el mateix amb "Ciudad" que es refereix a "Ciudad Real"

```{r La, echo=TRUE}
# 1. Passem la columna a text per poder modificar-la
x_neta$Location <- as.character(x_neta$Location)

# 2. Substituïm "La" per "La Coruña"
x_neta$Location[x_neta$Location == "La"] <- "La Coruña"

# 3. Substituïm Ciudad" per "La Coruña"
x_neta$Location[x_neta$Location == "Ciudad"] <- "Ciudad Real"

# 4. La tornem a convertir en Factor (important per als gràfics i el mapa)
x_neta$Location <- as.factor(x_neta$Location)


# 6. Verifiquem el canvi
summary(x_neta$Location)
```  

si tornem a fer sumary:

```{r summary x_neta, echo=TRUE}

summary(x_neta[, variables_utilitat])
```  
### Sticker

Veiem que hi ha 20 files que no tenen Sticker, són cotxes DIESEl del 2004 i 2005 segons la DGT aquest cotxes no tenen etiquetes, per tant, posaré sense etiqueta.
```{r sticker, echo=TRUE}

# 1. Creem la taula amb els 20 casos problemàtics
taula_revisio <- x_neta %>%
  filter(Sticker == "" | is.na(Sticker)) %>%
  select(Brand, Name, Year, Fuel)

# 2. Mostrem la taula per pantalla
print(taula_revisio)

x_neta <- x_neta %>%
  mutate(
    Sticker = as.character(Sticker),
    
    # Assignem només als que estan buits
    Sticker = ifelse(Sticker == "" | is.na(Sticker), "SENSE_ETIQUETA", Sticker),
    
    Sticker = as.factor(Sticker)
  )

# Comprova com ha quedat ara el resum
table(x_neta$Sticker)

``` 
Viem com queda el dataset:

```{r summary x_neta2, echo=TRUE}

summary(x_neta[, variables_utilitat])
```  
### Weight

Veiem quins models son els NA's:

```{r weight, echo=TRUE}
# 1. Creem la taula per veure quins cotxes no tenen pes
taula_pes_buit <- x_neta %>%
  filter(is.na(Weight)) %>%
  select(Brand, Name, Year, Fuel, CV) # Afegim CV perquè ajuda a identificar el motor

# 2. Mostrem els resultats
print(taula_pes_buit)

```  
He buscat el pes orientatiu d'aquest vehiscles: 

```{r weight_solucio, echo=TRUE}
x_neta <- x_neta %>%
  mutate(
    # Passem Name a text per identificar-los bé
    Name = as.character(Name),
    
    # Assignem el pes segons el nom del model on el pes sigui NA
    Weight = case_when(
      !is.na(Weight) ~ Weight,  # Si ja té pes, el mantenim
      
      grepl("Rimor", Name, ignore.case = TRUE) ~ 3000,   # Autocaravana
      grepl("Daily", Name, ignore.case = TRUE) ~ 2200,   # Furgoneta gran
      grepl("Master", Name, ignore.case = TRUE) ~ 2000,  # Furgoneta mitjana
      grepl("YOYO", Name, ignore.case = TRUE)   ~ 850,    # Micro-cotxe elèctric
      
      TRUE ~ Weight # Per a qualsevol altre cas no previst
    )
  )

# Comprovem que ja no quedin NAs a Weight
sum(is.na(x_neta$Weight))

summary(x_neta[, variables_utilitat])

```


### X0to100 

Ara internarem buscar X0to100 del NAs per marcar i intentarem arreglar 352 és impossible que un cotxe triga pràcticament 6 minuts a arribar els 100 km. Amb aquest codi calculem la mitjana del mateix model de cotxe.

```{r X0to100, echo=TRUE}
x_neta <- x_neta %>%
  # 1. Convertim l'error (352) en NA perquè es pugui imputar
  mutate(X0to100 = ifelse(X0to100 > 50, NA, X0to100)) %>%
  
  # 2. Imputem per Marca i Nom (com hem fet amb el pes)
  group_by(Brand, Name) %>%
  mutate(X0to100 = ifelse(is.na(X0to100), 
                          mean(X0to100, na.rm = TRUE), 
                          X0to100)) %>%
  ungroup() %>%
  
  # 3. Si encara queda algun NA, imputem per Marca
  group_by(Brand) %>%
  mutate(X0to100 = ifelse(is.na(X0to100), 
                          mean(X0to100, na.rm = TRUE), 
                          X0to100)) %>%
  ungroup()

# Comprovació final del sumari de l'acceleració
summary(x_neta$X0to100)
```

Aquests 13 valors han quedat buits perquè, segurament, pertanyen a marques on en el dataset no hi ha registres d'acceleració de Marca o model.

Per solucionar-ho definitivament i arribar a 0 NAs, aplicarem la mediana global del dataset només a aquests 13 casos restants. 

He fet servir la mediana (el valor central) en lloc de la mitjana perquè és més segura: evita que els cotxes esportius molt ràpids o els camions molt lents distorsionin el valor que els donem a aquests 13 cotxes.


```{r X0to100_mediana, echo=TRUE}
# Imputació final amb la mediana de tot el dataset per als casos orfes
x_neta <- x_neta %>%
  mutate(X0to100 = ifelse(is.na(X0to100), 
                          median(X0to100, na.rm = TRUE), 
                          X0to100))

# Comprovació final absoluta
summary(x_neta$X0to100)
summary(x_neta[, variables_utilitat])
```
## Noves columnes

Aquestes mesures les pensava crear amb DAX per fer les gràfiques a Power BI però en aquest cas les crearé com a noves columnes:

Antiguitat: Variable fonamental per a l'Anàlisi de Depreciació. Ens permet segmentar el dataset en cotxes "Nous", "Semi-nous" i "Vells".

Ràtio Potència/Pes: Mesura l'agilitat del cotxe. És la mètrica d'originalitat que ens demanaven. Un valor alt indica un cotxe esportiu o molt eficient en la seva relació pes-potència.

Tram_KM: Agrupa els KM. Permet comparar si Seat aguanta millor el preu que Peugeot en el tram de "50k-100k"

Preu_per_CV: Indica quant paga el client per cada unitat de potència. Molt útil per comparar si les marques "Premium" (BMW, Mercedes) cobren el cavall de potència més car que les marques "Generalistes" (Seat, KIA).

Preu perkme: Relaciona el valor residual del cotxe amb el seu ús. Els cotxes amb un valor molt baix aquí són els que més s'han devaluat per quilòmetre recorregut.

Depreciació Anual: És una aproximació de la pèrdua de valor. Ens diu, de mitjana, quants euros val el cotxe per cada any que té.


```{r noves_columnes, echo=TRUE}

x_final <- x_neta %>%
  mutate(
    # 1. ANTIGUITAT (Pregunta Geoespacial)
    Antiguitat = 2025 - Year,
    
    # 2. RÀTIO POTÈNCIA/PES (Pregunta de Rendiment - Originalitat)
    Ratio_Pot_Pes = CV / Weight,
    
    # 3. TRAMS DE KM (Pregunta de Marques i Trams)
    Tram_KM = cut(KM, 
                  breaks = c(0, 20000, 50000, 100000, 200000, Inf), 
                  labels = c("0-20k", "20k-50k", "50k-100k", "100k-200k", "+200k"),
                  include.lowest = TRUE),
    
    # 4. PREU PER CAVALL (Pregunta de Valoració Tècnica)
    Preu_per_CV = Price / CV,
    
    # 5. DEPRECIACIÓ ANUAL (Pregunta de Depreciació Local)
    Depreciacio_Anual = Price / pmax(Antiguitat, 1),
    
    # 6. PREU PER KM (Pregunta de Depreciació Clàssica)
    Preu_per_KM = Price / pmax(KM, 1)
  )

# Comprovem que tot s'ha creat correctament
summary(x_final[, c("Antiguitat", "Ratio_Pot_Pes", "Preu_per_CV", "Depreciacio_Anual", "Preu_per_KM")])
```



## Exportem dataset:
```{r export_dataset, echo=TRUE}

write.csv(x_final, "dataset_final_cotxe.csv", row.names = FALSE)

print ("El dataset s'ha exportat de forma correcta")

```


